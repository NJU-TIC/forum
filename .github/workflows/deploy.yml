name: CI and Deploy

on:
  push:
    branches:
      - main
      - feat/github-action
  workflow_dispatch:

concurrency:
  group: forum-deploy-main
  cancel-in-progress: true

jobs:
  ci:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

  deploy:
    name: Deploy to Linux Server
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feat/github-action'
    permissions:
      contents: read
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_APP_DIR: ${{ secrets.SERVER_APP_DIR }}
      SYSTEMD_SERVICE: ${{ secrets.SYSTEMD_SERVICE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SERVER_PORT:-22}" -H "${SERVER_HOST}" >> ~/.ssh/known_hosts

      - name: Sync files to server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude ".next" \
            --exclude "config.json" \
            -e "ssh -p ${SERVER_PORT:-22}" \
            ./ "${SERVER_USER}@${SERVER_HOST}:${SERVER_APP_DIR}"

      - name: Install and restart service
        run: |
          ssh -p "${SERVER_PORT:-22}" "${SERVER_USER}@${SERVER_HOST}" \
            "SERVER_APP_DIR='${SERVER_APP_DIR}' SYSTEMD_SERVICE='${SYSTEMD_SERVICE}' bash -s" <<'EOF'
          set -euo pipefail

          if [ -z "${SYSTEMD_SERVICE:-}" ]; then
            echo "SYSTEMD_SERVICE secret is empty."
            exit 1
          fi

          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"

          cd "$SERVER_APP_DIR"
          bun install --frozen-lockfile

          sudo systemctl daemon-reload

          if ! sudo systemctl restart "$SYSTEMD_SERVICE"; then
            sudo systemctl status "$SYSTEMD_SERVICE" --no-pager || true
            sudo journalctl -u "$SYSTEMD_SERVICE" -n 200 --no-pager || true
            exit 1
          fi

          sudo systemctl is-active "$SYSTEMD_SERVICE"
          EOF

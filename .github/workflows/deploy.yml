name: CI and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: forum-deploy-main
  cancel-in-progress: true

jobs:
  ci:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Prepare config for CI build
        run: cp config.example.json config.json

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build

  deploy:
    name: Deploy to Linux Server
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main'
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_APP_DIR: ${{ secrets.SERVER_APP_DIR }}
      SYSTEMD_SERVICE: ${{ secrets.SYSTEMD_SERVICE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SERVER_PORT:-22}" -H "${SERVER_HOST}" >> ~/.ssh/known_hosts

      - name: Sync files to server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude ".next" \
            --exclude "config.json" \
            -e "ssh -p ${SERVER_PORT:-22}" \
            ./ "${SERVER_USER}@${SERVER_HOST}:${SERVER_APP_DIR}"

      - name: Install, build and restart service
        run: |
          SERVER_APP_DIR_ESCAPED=$(printf '%q' "$SERVER_APP_DIR")
          SYSTEMD_SERVICE_ESCAPED=$(printf '%q' "$SYSTEMD_SERVICE")

          ssh -p "${SERVER_PORT:-22}" "${SERVER_USER}@${SERVER_HOST}" "SERVER_APP_DIR=${SERVER_APP_DIR_ESCAPED} SYSTEMD_SERVICE=${SYSTEMD_SERVICE_ESCAPED} bash -s" <<'EOF'
          set -euo pipefail

          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"

          cd "$SERVER_APP_DIR"
          bun install --frozen-lockfile
          bun run build

          if [ -z "${SYSTEMD_SERVICE:-}" ]; then
            echo "SYSTEMD_SERVICE secret is empty."
            exit 1
          fi

          sudo systemctl restart "$SYSTEMD_SERVICE"
          sudo systemctl is-active "$SYSTEMD_SERVICE"
          EOF
